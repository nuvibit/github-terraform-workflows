name: TERRAFORM MODULE RELEASE

on:
  workflow_call:
    inputs:
      toggle_branch_protection:
        description: 'Temporary disable branch protection to allow release action to push updates to changelog'
        default: true
        required: false
        type: boolean
      semantic_version:
        description: 'Specify specifying version range for semantic-release'
        default: '18.0.0'
        required: false
        type: string
      semantic_release_config:
        description: 'Shareable config to create release of Terraform Modules'
        default: '@nuvibit/github-terraform-semantic-release-config'
        required: false
        type: string
      release_branch:
        description: 'Name of branch on which Terraform Module release should happen'
        default: 'main'
        required: false
        type: string
    secrets:
      GHE_API_TOKEN:
        required: true

# Ensures that only one workflow runs at a time
concurrency: ${{ github.repository }}/${{ github.event.pull_request.head.ref || github.ref }}

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      semantic_status: ${{ steps.semantic.outputs.new_release_published }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Check Branch Protection
        if: ${{ inputs.toggle_branch_protection }}
        uses: octokit/request-action@v2.x
        id: get_branch_protection
        continue-on-error: true
        with:
          route: GET /repos/${{ github.repository }}/branches/${{ inputs.release_branch }}/protection
        env:
          GITHUB_TOKEN: ${{ secrets.GHE_API_TOKEN }}
      
      - name: Temporarily Disable Branch Protection
        if: ${{ inputs.toggle_branch_protection && steps.get_branch_protection.outputs.status == '200' }}
        uses: octokit/request-action@v2.x
        id: branch_protection_update
        with:
          route: PUT /repos/${{ github.repository }}/branches/${{ inputs.release_branch }}/protection
          required_status_checks: |
            null
          enforce_admins: |
            false
          required_pull_request_reviews: |
            null
          restrictions: |
            null
        env:
          GITHUB_TOKEN: ${{ secrets.GHE_API_TOKEN }}

      - name: Release Terraform Module
        uses: cycjimmy/semantic-release-action@v3
        id: semantic
        with:
          semantic_version: ${{ inputs.semantic_version }}
          branch: ${{ inputs.release_branch }}
          extends: |
            ${{ inputs.semantic_release_config }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Branch Protection
        if: ${{ always() && inputs.toggle_branch_protection && steps.get_branch_protection.outputs.status == '200' }}
        uses: octokit/request-action@v2.x
        with:
          route: PUT /repos/${{ github.repository }}/branches/${{ inputs.release_branch }}/protection
          required_status_checks: |
            {
              "strict": ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).required_status_checks.strict) || null }},
              "checks": ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).required_status_checks.checks) || null }}
            }
          enforce_admins: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).enforce_admins.enabled) || null }}
          required_pull_request_reviews: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).required_pull_request_reviews) || null }}
          restrictions: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).restrictions) || null }}
          required_linear_history: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).required_linear_history.enabled) || null }}
          allow_force_pushes: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).allow_force_pushes.enabled) || null }}
          allow_deletions: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).allow_deletions.enabled) || null }}
          block_creations: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).block_creations.enabled) || null }}
          required_conversation_resolution: |
            ${{ toJson(fromJson(steps.get_branch_protection.outputs.data).required_conversation_resolution.enabled) || null }}
        env:
          GITHUB_TOKEN: ${{ secrets.GHE_API_TOKEN }}

  workflow-summary:
    needs:
      - release
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
      - name: Do something when a new release published
        if: ${{ needs.release.outputs.semantic_status == 'true' }}
        run: |
          echo "previous version: ${{ steps.semantic.outputs.last_release_version }}"
          echo "new version: ${{ steps.semantic.outputs.new_release_version }}"
          echo "major: ${{ steps.semantic.outputs.new_release_major_version }}"
          echo "minor: ${{ steps.semantic.outputs.new_release_minor_version }}"
          echo "patch: ${{ steps.semantic.outputs.new_release_patch_version }}"

      # - name: Workflow Summary
      #   env:
      #     TFE_PLAN_URL: ${{ needs.terraform-run.outputs.tfe_plan_url }}
      #     TFE_APPLY_URL: ${{ needs.terraform-run.outputs.tfe_apply_url }}
      #     TERRAFORM_VERSION: ${{ needs.terraform-fmt.outputs.terraform_version }}
      #     TF_FMT_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-fmt.outputs.fmt_status != 'success'] }}
      #     TF_DOCS_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-docs.outputs.docs_status != 'success'] }}
      #     TF_LINT_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-lint.outputs.lint_status != 'success'] }}
      #     TF_SECURITY_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-security.outputs.security_status != 'success'] }}
      #     TF_INIT_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-run.outputs.init_status != 'success'] }}
      #     TF_PLAN_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-run.outputs.plan_status != 'success'] }}
      #     TF_APPLY_RESULT: ${{ fromJSON('[":white_check_mark:", ":x:"]')[needs.terraform-run.outputs.plan_status != 'success'] }}
      #     TF_PLAN_OR_APPLY: ${{ fromJSON('["plan", "apply"]')[github.event_name != 'push'] }}
      #   run: |
      #     echo '### WORKFLOW SUMMARY :octocat:' >> $GITHUB_STEP_SUMMARY
      #     echo '' >> $GITHUB_STEP_SUMMARY
      #     echo '| result | job |' >> $GITHUB_STEP_SUMMARY
      #     echo '|---|---|' >> $GITHUB_STEP_SUMMARY
      #     echo '| ${{ env.TF_FMT_RESULT }} | terraform format |' >> $GITHUB_STEP_SUMMARY
      #     echo '| ${{ env.TF_DOCS_RESULT }} | terraform docs |' >> $GITHUB_STEP_SUMMARY
      #     echo '| ${{ env.TF_LINT_RESULT }} | terraform lint |' >> $GITHUB_STEP_SUMMARY
      #     echo '| ${{ env.TF_SECURITY_RESULT }} | terraform security |' >> $GITHUB_STEP_SUMMARY
      #     echo '| ${{ env.TF_PLAN_RESULT || env.TF_APPLY_RESULT }} | terraform [${{ env.TF_PLAN_OR_APPLY }}](${{ env.TFE_PLAN_URL || env.TFE_APPLY_URL }}) |' >> $GITHUB_STEP_SUMMARY
